sudo: required
dist: trusty
language: ruby

before_install:
- gem install asciidoctor -v 1.5.2
- gem install tilt
- sudo pip install git+https://github.com/gitenberg-dev/gitberg
- sudo pip install git+https://github.com/gitenberg-dev/pg-epubmaker
script:
- VERSION=`ruby -e "require 'yaml'; meta = YAML.load_file('metadata.yaml'); puts meta['_version'];"`
- git clone https://github.com/gitenberg-dev/asciidoctor-htmlbook.git
- sudo pip install -r asciidoctor-htmlbook/gitberg-machine/requirements.txt

- /usr/bin/python -c "from gitenberg import travis; travis.build_epub()"
- ebook-convert book.epub book.mobi
- xvfb-run ebook-convert book.epub book.pdf
notifications:
  webhooks:
    urls:
      - https://unglue.it/api/travisci/webhook
    on_success: always
    on_failure: never
    on_start: never
deploy:
  skip_cleanup: true
  provider: releases
  api_key:
    secure: egSHKdOxz90oGgT9dz3btd8n+CuYzZiF+7ESlzWvrFjNJAkDFu6i4l8XRTlbK8Db0edSf7BU2+vyujEdeEv1NYzab4CPkc1eqOnX7u9zsa63xKHZ9YBrQMgU+2uf7dm6N/ZCDvvhtgvW8vAJ5fpBaZLzj8r6Pdp8Rj6Cu1xzVS4+d6zt7EmVr3uqZvWXR0bnHXRqjuliqLlivOTZsTo9iSipQ+YF/fyygz1DAXRpa8WL3M/RVVutbsjieA322H7PTcjHZwl0eVV4Bax+DyiUSp297yHTqQq76wLevMm7LzwregMS7uDw1+Y96PX5YB6uoeA0EfXopx5XPngvkROAKx49gKnOIr9ipTQQ4hHa1eWK7IJ4sDsJH1SAOcgfZhsnmxkDmhJ6cfooeS54VeS4Kxj9FHWY0qsT0eAKu7UHrPj3Qu2sQUk3nZZFp1v92tlsbXFnNA9FPus8ZJivy2EDMkD50xrDdtywUz7NDlmpuq1Hs/3nLXatYk0HkU5JekJenRHfKzcnoz+yhOUtgjqDmovXn/gpwIytkcHhv+S9LkqzrDm8C6s5xXSqM0xMPLn3o5iNwWzrP+tT/K0hpcWjd4tbpEXU3H05BrkLOcXixSwq4t0YwErBlpTMN3cer67Qa+XqQRylwu9ZklW6QLgct+fSTLVA3A9ddcXOCXMPQMM=
  file:
    - book.epub
    - book.mobi
    - book.pdf
  on:
    repo: GITenberg/The-Golden-Slipper-and-Other-Problems-for-Violet-Strange_3071
    tags: true
addons:
  apt:
    packages:
    - xsltproc
    - xvfb
    - calibre
    - python-pip
    - git
    - python-dev
    - libjpeg-dev
    - libpng-dev
    - libfreetype6
    - libfreetype6-dev
    - zlib1g-dev
    - python-lxml
    - libxml2-dev
    - libxslt1-dev
    - tidy